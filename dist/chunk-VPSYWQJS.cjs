'use strict';

var chunk57AVKP4H_cjs = require('./chunk-57AVKP4H.cjs');
var reactHooksAsync = require('@chengsokdara/react-hooks-async');
var react = require('react');

var oe={apiKey:"",autoStart:!1,autoTranscribe:!0,mode:"transcriptions",nonStop:!1,removeSilence:!1,stopTimeout:5e3,streaming:!1,timeSlice:1e3,onDataAvailable:void 0,onTranscribe:void 0,onProcessAudioChunk:void 0},ae={stop:void 0},ie={blob:void 0,text:void 0},pe=M=>{let{apiKey:f,autoStart:A,autoTranscribe:C,mode:h,nonStop:v,removeSilence:O,stopTimeout:q,streaming:S,timeSlice:I,whisperConfig:u,onDataAvailable:K,onTranscribe:U,onProcessAudioChunk:B}={...oe,...M},d=react.useRef([]),i=react.useRef(),s=react.useRef(),t=react.useRef(),a=react.useRef(),l=react.useRef(ae),[$,T]=react.useState(!1),[j,W]=react.useState(!1),[z,g]=react.useState(!1),[N,m]=react.useState(ie);react.useEffect(()=>()=>{d.current&&(d.current=[]),i.current&&(i.current.flush(),i.current=void 0),t.current&&(t.current.destroy(),t.current=void 0),b("stop"),s.current&&(s.current.off("speaking",k),s.current.off("stopped_speaking",R)),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=void 0);},[]),reactHooksAsync.useEffectAsync(async()=>{A&&await x();},[A]);let G=async()=>{await x();},J=async()=>{await X();},Q=async()=>{await E();},x=async()=>{try{if(a.current||await V(),a.current){if(!t.current){let{default:{RecordRTCPromisesHandler:r,StereoAudioRecorder:o}}=await import('recordrtc'),n={mimeType:"audio/wav",numberOfAudioChannels:1,recorderType:o,sampleRate:44100,timeSlice:S?I:void 0,type:"audio",ondataavailable:C&&S?ee:void 0};t.current=new r(a.current,n);}if(!i.current){let{Mp3Encoder:r}=await import('lamejs');i.current=new r(1,44100,96);}let e=await t.current.getState();(e==="inactive"||e==="stopped")&&await t.current.startRecording(),e==="paused"&&await t.current.resumeRecording(),v&&F("stop"),T(!0);}}catch{}},V=async()=>{try{if(a.current&&a.current.getTracks().forEach(e=>e.stop()),a.current=await navigator.mediaDevices.getUserMedia({audio:!0}),!s.current){let{default:e}=await import('hark');s.current=e(a.current,{interval:100,play:!1}),s.current.on("speaking",k),s.current.on("stopped_speaking",R);}}catch{}},F=e=>{l.current[e]||(l.current[e]=setTimeout(E,q));},k=()=>{W(!0),b("stop");},R=()=>{W(!1),v&&F("stop");},X=async()=>{try{t.current&&(await t.current.getState()==="recording"&&await t.current.pauseRecording(),b("stop"),T(!1));}catch{}},E=async()=>{try{if(t.current){let e=await t.current.getState();if((e==="recording"||e==="paused")&&await t.current.stopRecording(),Y(),b("stop"),T(!1),C)await Z();else {let r=await t.current.getBlob();m({blob:r});}await t.current.destroy(),d.current=[],i.current&&(i.current.flush(),i.current=void 0),t.current=void 0;}}catch{}},Y=()=>{s.current&&(s.current.off("speaking",k),s.current.off("stopped_speaking",R),s.current=void 0),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=void 0);},b=e=>{l.current[e]&&(clearTimeout(l.current[e]),l.current[e]=void 0);},Z=async()=>{try{if(i.current&&t.current&&await t.current.getState()==="stopped"){g(!0);let r=await t.current.getBlob();if(O){let{createFFmpeg:o}=await import('@ffmpeg/ffmpeg'),n=o({mainName:"main",corePath:chunk57AVKP4H_cjs.b,log:!0});n.isLoaded()||await n.load();let c=await r.arrayBuffer();n.FS("writeFile","in.wav",new Uint8Array(c)),await n.run("-i","in.wav","-acodec","libmp3lame","-b:a","96k","-ar","44100","-af",chunk57AVKP4H_cjs.c,"out.mp3");let w=n.FS("readFile","out.mp3");if(w.length<=225){n.exit(),m({blob:r}),g(!1);return}r=new Blob([w.buffer],{type:"audio/mpeg"}),n.exit();}else {let o=await r.arrayBuffer(),n=i.current.encodeBuffer(new Int16Array(o));r=new Blob([n],{type:"audio/mpeg"});}if(typeof U=="function"){let o=await U(r);m(o);}else if(f){let o=new File([r],"speech.mp3",{type:"audio/mpeg"}),n=await H(o);m({blob:r,text:n});}g(!1);}}catch{g(!1);}},ee=async e=>{try{if(S&&t.current){if(K?.(e),i.current){let o=await e.arrayBuffer(),n=i.current.encodeBuffer(new Int16Array(o)),c=new Blob([n],{type:"audio/mpeg"});d.current.push(c);}if(await t.current.getState()==="recording"){let o=new Blob(d.current,{type:"audio/mpeg"}),n=new File([o],"speech.mp3",{type:"audio/mpeg"}),c="";typeof B=="function"?c=await B(n):f&&(c=await H(n)),c&&m(w=>({...w,text:c}));}}}catch{}},H=reactHooksAsync.useMemoAsync(async e=>{let r=new FormData;r.append("file",e),r.append("model","whisper-1"),h==="transcriptions"&&r.append("language",u?.language??"en"),u?.prompt&&r.append("prompt",u.prompt),u?.response_format&&r.append("response_format",u.response_format),u?.temperature&&r.append("temperature",`${u.temperature}`);let o={};o["Content-Type"]="multipart/form-data",f&&(o.Authorization=`Bearer ${f}`);let{default:n}=await import('axios');return (await n.post(chunk57AVKP4H_cjs.d+h,r,{headers:o})).data.text},[f,h,u]);return {recording:$,speaking:j,transcribing:z,transcript:N,pauseRecording:J,startRecording:G,stopRecording:Q}};

exports.a = pe;
